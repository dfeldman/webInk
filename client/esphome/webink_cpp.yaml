# WebInk ESPHome Configuration (C++ Component Version)
# Replaces the complex YAML scripts with modular C++ component

# Configuration values (can use secrets or override)
substitutions:
  webink_server_url: "http://192.168.10.100:8000"      # Local server (change if remote)
  webink_device_id: "webink-cpp-display"
  webink_api_key: "myapikey"
  webink_display_mode: "800x480x1xB"  
  webink_socket_port: "8001"  # 0 = HTTP sliced mode, >0 = TCP socket mode

esphome:
  name: webink-display-cpp
  friendly_name: "WebInk Display (C++)"
  platformio_options:
    # Increase build memory for C++ component
    build_flags: 
      - -DBOARD_HAS_PSRAM
    build_unflags:
      - -fno-exceptions

esp32:
  board: esp32-c3-devkitm-1
  framework:
    type: esp-idf
    version: recommended
    sdkconfig_options:
      CONFIG_ESP_TASK_WDT_TIMEOUT_S: "30"
      CONFIG_FREERTOS_THREAD_LOCAL_STORAGE_POINTERS: "2"
      CONFIG_ESP_MAIN_TASK_STACK_SIZE: "16384"
    advanced:
      loop_task_stack_size: 16384

# Enable logging
logger:
  level: DEBUG
  logs:
    webink: INFO
    webink.controller: INFO
    webink.network: DEBUG
    webink.image: INFO
    webink.display: INFO

# DISABLED: API server uses too much stack
# api:

# Enable OTA updates
ota:
  - platform: esphome
    password: !secret ota_password

# Web server for local UI - re-enabling
web_server:
  port: 80
  version: 3

# mDNS
mdns:
  disabled: false

# WiFi configuration
wifi:
  networks:
    - ssid: !secret wifi_ssid
      password: !secret wifi_password
  enable_on_boot: true
  
  # Enable captive portal for configuration
  ap:
    ssid: "WebInk Display Setup"
    password: "webink123"

  # DISABLED: Lambda on WiFi connect causes stack overflow
  # on_connect:
  #   - lambda: |-
  #       if (id(webink_ctrl)->get_boot_cycles() == 0) {
  #         ESP_LOGI("webink", "Initial WiFi connection - triggering first update");
  #         id(webink_ctrl)->trigger_manual_update();
  #       }


# DISABLED: Captive portal uses too much stack
# captive_portal:

# SPI bus for the display
spi:
  clk_pin: GPIO8
  mosi_pin: GPIO10

# E-ink display
display:
  - platform: waveshare_epaper
    id: epd
    model: 7.50inV2
    cs_pin: GPIO3
    dc_pin: GPIO5
    reset_pin: GPIO2
    busy_pin:
      number: GPIO4
      inverted: true
    update_interval: never  # WebInk controls updates

# Deep sleep component
deep_sleep:
  id: deep_sleep_control
  sleep_duration: 5min

# HTTP request component (required by WebInk)
http_request:
  id: http_client
  useragent: "WebInk/1.0"
  timeout: 10s

# BOOT button for safety override
binary_sensor:
  - platform: gpio
    pin:
      number: GPIO9
      inverted: true
      mode:
        input: true
        pullup: true
    name: "BOOT Button"
    id: boot_button

# Fonts for the WebInk component
font:
  - file:
      type: gfonts
      family: Roboto
      weight: 400
    id: roboto_16
    size: 16
    glyphs: '!"#$%&''()*+,-./:;<=>?@[\]^_`{|}~ 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz°'

  - file:
      type: gfonts
      family: Roboto
      weight: 700
    id: roboto_24
    size: 24
    glyphs: '!"#$%&''()*+,-./:;<=>?@[\]^_`{|}~ 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz°'

# Include WebInk C++ component (local directory)
external_components:
  - source: 
      type: local
      path: webink_component
    components: [ webink ]

# WebInk component configuration
webink:
  id: webink_ctrl
  server_url: "${webink_server_url}"
  device_id: "${webink_device_id}"
  api_key: "${webink_api_key}"
  display_mode: "${webink_display_mode}"
  socket_port: ${webink_socket_port}
  rows_per_slice: 8
  display_id: epd
  normal_font: roboto_16  
  large_font: roboto_24
  deep_sleep_id: deep_sleep_control


# Status sensors
text_sensor:
  # DISABLED: get_status_string() still returns std::string - keep disabled
  # - platform: template
  #   name: "WebInk Status"
  #   id: webink_status
  #   update_interval: 30s
  #   lambda: |-
  #     return id(webink_ctrl)->get_status_string();

  # State sensor - now returns const char* to avoid stack allocation
  - platform: template
    name: "WebInk State"
    id: webink_state
    update_interval: 10s
    lambda: |-
      return std::string(id(webink_ctrl)->get_current_state_string());

  # Hash sensor - now returns const char* to avoid stack allocation
  - platform: template
    name: "Last Hash"
    id: last_hash
    update_interval: 60s
    lambda: |-
      return std::string(id(webink_ctrl)->get_last_hash());

  # WiFi info sensors - built-in, should be safe
  - platform: wifi_info
    ip_address:
      name: "IP Address"
    ssid:
      name: "WiFi SSID"

sensor:
  # Numeric sensors - return primitives, should be stack-safe
  - platform: template
    name: "Wake Counter"
    id: wake_counter
    update_interval: 30s
    lambda: |-
      return id(webink_ctrl)->get_wake_counter();

  - platform: template
    name: "Boot Cycles"
    id: boot_cycles
    update_interval: 30s
    lambda: |-
      return id(webink_ctrl)->get_boot_cycles();

  - platform: template
    name: "Update Progress"
    id: update_progress
    unit_of_measurement: "%"
    update_interval: 5s
    lambda: |-
      return id(webink_ctrl)->get_progress_percentage();

  # Built-in sensors - re-enabling
  - platform: uptime
    name: "Uptime"
    update_interval: 60s

  - platform: wifi_signal
    name: "WiFi Signal"
    update_interval: 60s

# Control buttons - simple lambdas that call existing methods
button:
  - platform: template
    name: "Manual Update"
    on_press:
      lambda: |-
        id(webink_ctrl)->trigger_manual_update();

  - platform: template
    name: "Force Refresh"
    on_press:
      lambda: |-
        id(webink_ctrl)->clear_hash_force_update();

  - platform: template
    name: "Sleep Now"
    on_press:
      lambda: |-
        id(webink_ctrl)->trigger_deep_sleep();

# Deep Sleep switch - returns bool primitive, should be safe
switch:
  - platform: template
    name: "Deep Sleep Enabled"
    id: deep_sleep_switch
    restore_mode: RESTORE_DEFAULT_ON
    optimistic: true
    lambda: |-
      return id(webink_ctrl)->is_deep_sleep_enabled_state();
    turn_on_action:
      lambda: |-
        id(webink_ctrl)->enable_deep_sleep(true);
    turn_off_action:
      lambda: |-
        id(webink_ctrl)->enable_deep_sleep(false);

# Text inputs - getters return const char*, converted to std::string at boundary
text:
  - platform: template
    name: "Server URL"
    optimistic: false
    mode: text
    lambda: |-
      return std::string(id(webink_ctrl)->get_server_url_config());
    set_action:
      lambda: |-
        id(webink_ctrl)->update_server_url(x);

  - platform: template
    name: "Device ID"
    optimistic: false
    mode: text
    lambda: |-
      return std::string(id(webink_ctrl)->get_device_id_config());
    set_action:
      lambda: |-
        id(webink_ctrl)->update_device_id(x);

  - platform: template
    name: "Display Mode"
    optimistic: false
    mode: text
    lambda: |-
      return std::string(id(webink_ctrl)->get_display_mode_config());
    set_action:
      lambda: |-
        id(webink_ctrl)->update_display_mode(x);

# Number input - returns int primitive, should be stack-safe
number:
  - platform: template
    name: "Socket Port"
    optimistic: false
    min_value: 0
    max_value: 65535
    step: 1
    mode: box
    lambda: |-
      return id(webink_ctrl)->get_socket_port_config();
    set_action:
      lambda: |-
        id(webink_ctrl)->update_socket_port((int)x);

